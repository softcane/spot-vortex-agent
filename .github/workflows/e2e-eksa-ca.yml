name: E2E - EKS Anywhere Docker + Cluster Autoscaler

on:
  workflow_dispatch:
    inputs:
      management_cluster_name:
        description: "EKS Anywhere management cluster name"
        required: false
        type: string
        default: "spotvortex-eksa-mgmt"
      workload_cluster_name:
        description: "EKS Anywhere workload cluster name"
        required: false
        type: string
        default: "spotvortex-eksa-ca"

jobs:
  e2e-eksa-ca:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install prerequisites
        run: |
          set -euo pipefail

          sudo apt-get update
          sudo apt-get install -y jq

          if ! command -v yq >/dev/null 2>&1; then
            curl -fsSL -o /tmp/yq https://github.com/mikefarah/yq/releases/download/v4.44.6/yq_linux_amd64
            chmod +x /tmp/yq
            sudo mv /tmp/yq /usr/local/bin/yq
          fi

          if ! command -v kind >/dev/null 2>&1; then
            curl -fsSL -o /tmp/kind https://kind.sigs.k8s.io/dl/v0.23.0/kind-linux-amd64
            chmod +x /tmp/kind
            sudo mv /tmp/kind /usr/local/bin/kind
          fi

          if ! command -v eksctl >/dev/null 2>&1; then
            # Pin eksctl to v0.204.0
            mkdir -p /tmp/eksctl_dl
            curl --silent --location "https://github.com/eksctl-io/eksctl/releases/download/v0.204.0/eksctl_Linux_amd64.tar.gz" \
              | tar xz -C /tmp/eksctl_dl
            sudo mv /tmp/eksctl_dl/eksctl /usr/local/bin/eksctl
            rm -rf /tmp/eksctl_dl
          fi

          if ! command -v clusterctl >/dev/null 2>&1; then
            # Pin to v1.9.5 to avoid GitHub API rate limits (403)
            curl -fsSL https://github.com/kubernetes-sigs/cluster-api/releases/download/v1.9.5/clusterctl-linux-amd64 -o /tmp/clusterctl
            chmod +x /tmp/clusterctl
            sudo mv /tmp/clusterctl /usr/local/bin/clusterctl
          fi

          if ! command -v eksctl-anywhere >/dev/null 2>&1; then
            # Pin eksctl-anywhere to v0.22.1 (GitHub Release)
            mkdir -p /tmp/eksa_dl
            curl -fsSL "https://github.com/aws/eks-anywhere/releases/download/v0.22.1/eksctl-anywhere-v0.22.1-linux-amd64.tar.gz" -o /tmp/eksa_dl/archive.tar.gz
            tar -xzf /tmp/eksa_dl/archive.tar.gz -C /tmp/eksa_dl
            sudo mv /tmp/eksa_dl/eksctl-anywhere /usr/local/bin/eksctl-anywhere
            rm -rf /tmp/eksa_dl
          fi

          kind version
          eksctl version
          eksctl anywhere version
          clusterctl version

      - name: Setup EKS Anywhere + Cluster Autoscaler
        id: setup
        env:
          MGMT_CLUSTER_NAME: ${{ inputs.management_cluster_name }}
          WORKLOAD_CLUSTER_NAME: ${{ inputs.workload_cluster_name }}
        run: |
          set -euo pipefail

          chmod +x tests/e2e/setup-eksa-ca.sh
          SETUP_OUTPUT="$(tests/e2e/setup-eksa-ca.sh)"
          echo "$SETUP_OUTPUT"

          MGMT_KUBECONFIG="$(echo "$SETUP_OUTPUT" | awk -F= '/^MANAGEMENT_KUBECONFIG=/{print $2}' | tail -n1)"
          WORKLOAD_KUBECONFIG="$(echo "$SETUP_OUTPUT" | awk -F= '/^WORKLOAD_KUBECONFIG=/{print $2}' | tail -n1)"

          if [[ -z "$MGMT_KUBECONFIG" || -z "$WORKLOAD_KUBECONFIG" ]]; then
            echo "setup-eksa-ca.sh did not emit kubeconfig paths" >&2
            exit 1
          fi

          echo "management_kubeconfig=$MGMT_KUBECONFIG" >> "$GITHUB_OUTPUT"
          echo "workload_kubeconfig=$WORKLOAD_KUBECONFIG" >> "$GITHUB_OUTPUT"

      - name: Run EKS Anywhere + CA suite
        env:
          KUBECONFIG: ${{ steps.setup.outputs.workload_kubeconfig }}
          SPOTVORTEX_E2E_SUITE: eksa-ca
        run: make test-e2e-eksa
